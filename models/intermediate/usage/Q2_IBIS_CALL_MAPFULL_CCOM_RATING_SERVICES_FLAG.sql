{{ config(
    materialized='table',
    pre_hook="DROP TABLE IF EXISTS {{ this }}"
    ) 
}}

select
  A.CALL_DT,              
    A.IN_CDR_FILE_ID,        
    A.IN_CDR_SERIAL_NR,
    A.IN_SEGMENT_DT,        
    A.OUT_CDR_FILE_ID,      
    A.OUT_CDR_SERIAL_NR,
  C.ONNET_OFFNET_FLAG,
    C.VAS_PORT_IN,
    C.VAS_PORT_OUT,
    A.OUT_SEGMENT_DT,        
    A.MAP_STATUS,            
    A.TRANSM_OPER_ID,
    A.I_TGC_ID,              
    A.RECV_OPER_ID,          
    A.O_TGC_ID,
    A.IN_DEST_OPER_ID,      
    A.OUT_DEST_OPER_ID,
    A.CALL_SET_UP_DURATION,  
    A.CALL_DURATION_TM,      
    A.ADD_ORIG_OPER_ID,
    A.DIALLED_NR,            
    A.ROUTED_NR,            
    A.A_NR,
    A.IN_DEST_SUB_SVC_ID,    
    A.OUT_DEST_SUB_SVC_ID,  
    A.IN_VAS_DIRECTION,
    A.IN_VAS_PRODUCT,        
    A.IN_VAS_ACCESS_NUMBER,  
    A.IN_VAS_CUSTOMER_ROUTING_NUMBER,
    A.IN_VAS_B_NUMBER,      
    A.IN_VAS_B_NUMBER_CTRY_CD,
    A.OUT_VAS_DIRECTION,    
    A.OUT_VAS_PRODUCT,        
    A.OUT_VAS_ACCESS_NUMBER,
    A.OUT_VAS_CUSTOMER_ROUTING_NUMBER,
    A.OUT_VAS_B_NUMBER,      
    A.OUT_VAS_B_NUMBER_CTRY_CD,
    A.IN_GLOBAL_CALL_ID,
    A.OUT_GLOBAL_CALL_ID,
    A.IN_ACCOUNT_OPER_ID,
    A.IN_REVN_EXP_IND,
    A.IN_AMOUNT,
    A.IN_CURRENCY_ID,
    A.IN_NUMBER_OF_UNITS,
    A.IN_ORIGINAL_NUMBER_OF_UNITS,
    A.IN_TARIFF_ELEMENT_ID,
    A.IN_TARIFF_TYPE_ID,
    A.IN_TIME_DIFF_INTERVAL_ID,
    A.IN_UNIT_TARIFF,
    A.IN_TARIFF_GRP_ID,
    A.IN_TARIFF_PROD_SVC_ID,
    A.IN_RATING_TYPE_ID,
    A.IN_NUMBER_OF_CALLS,
    A.IN_UNIT_TARIFF_SETUP_FEE,
    A.IN_AMOUNT_SETUPFEE,
    A.IN_TARIFF_ELEMENT_ID_SETUPFEE,
    A.IN_IND,
    A.OUT_ACCOUNT_OPER_ID,
    A.OUT_REVN_EXP_IND,
    A.OUT_AMOUNT,
    A.OUT_CURRENCY_ID,  
    A.OUT_ORIGINAL_NUMBER_OF_UNITS,
    A.OUT_TARIFF_ELEMENT_ID,
    A.OUT_TARIFF_TYPE_ID,
    A.OUT_TIME_DIFF_INTERVAL_ID,
    A.OUT_UNIT_TARIFF,
    A.OUT_TARIFF_GRP_ID,
    A.OUT_TARIFF_PROD_SVC_ID,
    A.OUT_RATING_TYPE_ID,
    A.OUT_NUMBER_OF_CALLS,
    A.OUT_UNIT_TARIFF_SETUP_FEE,
    A.OUT_AMOUNT_SETUPFEE,
    A.OUT_TARIFF_ELEMENT_ID_SETUPFEE,
    A.OUT_IND,
    A.LOAD_DT,
    A.BEARER,
    A.DIRECTION,
    A.PRODUCT,
    A.SALES_DEST_DIALLED_NR,
    A.SALES_DEST_ROUTED_NR,
    A.DEST_SUB_SVC_CD,
    A.FIX_MOBILE,
    A.IN_DEST_ACCESS_AREA_ID,                
    A.OUT_DEST_ACCESS_AREA_ID,
    A.IN_UNIT_TARIFF_EURO_FINAL,
    A.OUT_UNIT_TARIFF_EURO_SAM,
    A.OUT_CHANGE_COMMENT_SAM,
    A.OUT_VIRTUAL_UNIT_TARIFF_EURO_SMART,
    A.OUT_CHANGE_COMMENT_SMART,
    A.OUT_UNIT_TARIFF_EURO_FINAL,
    A.OUT_CHANGE_COMMENT_FINAL,
    A.A_NR_CTRY_CD,
    A.B_NR_CTRY_CD,
    C.VAS_NAT_OUT_CALL_SRV_FLAG,
    A.DEST_OPER_ID,
    A.ROUTING_DEST_DIALLED_NR,
    A.ROUTING_DEST_ROUTED_NR,
    A.ORIGINAL_PRODUCT,
    A.CUST_OPER_ID,
    A.CUST_TGC_ID,
    A.CUST_CURRENCY_ID,
    A.ORIG_OPER_ID,
    A.SUPPL_OPER_ID,
    A.SUPPL_TGC_ID,
    A.SUPPL_CURRENCY_ID,
    A.CUST_DEST_SUB_SVC_ID,
    A.SUPPL_DEST_SUB_SVC_ID,
    A.IN_UNIT_TARIFF_EURO_FINANCIAL,
    A.IN_UNIT_TARIFF_OC_FINAL,
    A.IN_UNIT_TARIFF_OC_FINANCIAL,
    A.IN_UNIT_TARIFF_SETUP_FEE_OC,
    A.OUT_UNIT_TARIFF_EURO_COGS,
    A.OUT_UNIT_TARIFF_OC_FINAL,
    A.OUT_UNIT_TARIFF_OC_FINANCIAL,
    A.OUT_UNIT_TARIFF_SETUP_FEE_OC,
    A.IN_UNIT_TARIFF_EURO_CORR,
    A.IN_CHANGE_COMMENT_CORR,
    A.OUT_NUMBER_OF_UNITS,
    A.OUT_UNIT_TARIFF_EURO_CORR,
    A.OUT_CHANGE_COMMENT_CORR,
    A.IN_CHANGE_COMMENT_FINAL,
    A.REVENUE,
    A.COST,
    A.FLAG_IND,
    A.IN_UNIT_TARIFF_EURO,
    A.IN_UNIT_TARIFF_SETUP_FEE_EURO,
    A.IN_AMOUNT_EURO,
    A.IN_AMOUNT_SETUPFEE_EURO
from
{{ref('Q2_IBIS_CALL_MAPFULL_CCOM_RATING_updated_fields')}} A
left outer join
(
    SELECT  A.CALL_DT,
            A.IN_CDR_FILE_ID,            A.IN_CDR_SERIAL_NR,
            A.OUT_CDR_FILE_ID,           A.OUT_CDR_SERIAL_NR,
 
            B.VAS_NAT_OUT_CALL_SRV_FLAG,
            
            -- 1 = ONNET / 0 = OFFNET / NULL
            CASE WHEN A.DIRECTION = 'OUTBOUND'
                  THEN CASE WHEN A.A_NR_CTRY_CD = A.B_NR_CTRY_CD AND B.VAS_NAT_OUT_CALL_SRV_FLAG = 1
                               THEN 1
                               ELSE 0
                       END
                  ELSE NULL
            END AS ONNET_OFFNET_FLAG,
            B.VAS_PORT_IN,
            B.VAS_PORT_OUT
    FROM {{ref('Q2_IBIS_CALL_MAPFULL_CCOM_RATING_updated_fields')}}  A
    LEFT OUTER JOIN {{ref('Q2_CCOM_VAS_SERVICES_FLAGS')}} B
        ON COALESCE(A.IN_CDR_FILE_ID, A.OUT_CDR_FILE_ID) = COALESCE(B.IN_CDR_FILE_ID, B.OUT_CDR_FILE_ID)
       AND COALESCE(A.IN_CDR_SERIAL_NR, A.OUT_CDR_SERIAL_NR) = COALESCE(B.IN_CDR_SERIAL_NR, B.OUT_CDR_SERIAL_NR)
    GROUP BY 1,2,3,4,5,6,7,8,9
) C
 
   ON A.CALL_DT = C.CALL_DT
   AND COALESCE(A.IN_CDR_FILE_ID, 0) = COALESCE(C.IN_CDR_FILE_ID, 0)
   AND COALESCE(A.IN_CDR_SERIAL_NR, 0) = COALESCE(C.IN_CDR_SERIAL_NR, 0)
   AND COALESCE(A.OUT_CDR_FILE_ID, 0) = COALESCE(C.OUT_CDR_FILE_ID, 0)
   AND COALESCE(A.OUT_CDR_SERIAL_NR, 0) = COALESCE(C.OUT_CDR_SERIAL_NR, 0)
 