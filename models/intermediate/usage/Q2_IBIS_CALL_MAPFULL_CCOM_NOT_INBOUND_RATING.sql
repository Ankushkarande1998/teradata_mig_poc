-- File: 3

{{ config(
    materialized='ephemeral'
) }}

SELECT   IBNR.CALL_DT,               IBNR.IN_CDR_FILE_ID,        IBNR.IN_CDR_SERIAL_NR,
        IBNR.IN_SEGMENT_DT,         IBNR.OUT_CDR_FILE_ID,       IBNR.OUT_CDR_SERIAL_NR,
        IBNR.OUT_SEGMENT_DT,        IBNR.MAP_STATUS,            IBNR.TRANSM_OPER_ID,
        IBNR.I_TGC_ID,              IBNR.RECV_OPER_ID,          IBNR.O_TGC_ID,
        IBNR.IN_DEST_OPER_ID,       IBNR.OUT_DEST_OPER_ID,
        IBNR.CALL_SET_UP_DURATION,  IBNR.CALL_DURATION_TM,      IBNR.ADD_ORIG_OPER_ID,
        IBNR.DIALLED_NR,            IBNR.ROUTED_NR,             IBNR.A_NR,
        IBNR.IN_DEST_SUB_SVC_ID,    IBNR.OUT_DEST_SUB_SVC_ID,   IBNR.IN_VAS_DIRECTION,
        IBNR.IN_VAS_PRODUCT,        IBNR.IN_VAS_ACCESS_NUMBER,  IBNR.IN_VAS_CUSTOMER_ROUTING_NUMBER,
        IBNR.IN_VAS_B_NUMBER,       IBNR.IN_VAS_B_NUMBER_CTRY_CD,
        IBNR.OUT_VAS_DIRECTION,     IBNR.OUT_VAS_PRODUCT,        IBNR.OUT_VAS_ACCESS_NUMBER,
        IBNR.OUT_VAS_CUSTOMER_ROUTING_NUMBER,
        IBNR.OUT_VAS_B_NUMBER,      IBNR.OUT_VAS_B_NUMBER_CTRY_CD,
        IBNR.IN_GLOBAL_CALL_ID,
        IBNR.OUT_GLOBAL_CALL_ID,

        RAT_IN.OPER_ID AS IN_ACCOUNT_OPER_ID,
        RAT_IN.REVN_EXP_IND AS IN_REVN_EXP_IND,
        RAT_IN.AMOUNT AS IN_AMOUNT,
        RAT_IN.CURRENCY_ID AS IN_CURRENCY_ID,
        RAT_IN.NUMBER_OF_UNITS AS IN_NUMBER_OF_UNITS,
        RAT_IN.ORIGINAL_NUMBER_OF_UNITS AS IN_ORIGINAL_NUMBER_OF_UNITS,
        RAT_IN.TARIFF_ELEMENT_ID AS IN_TARIFF_ELEMENT_ID,
        RAT_IN.TARIFF_TYPE_ID AS IN_TARIFF_TYPE_ID,
        RAT_IN.TIME_DIFF_INTERVAL_ID AS IN_TIME_DIFF_INTERVAL_ID,
        RAT_IN.UNIT_TARIFF AS IN_UNIT_TARIFF,
        RAT_IN.TARIFF_GRP_ID AS IN_TARIFF_GRP_ID,
        RAT_IN.TARIFF_PROD_SVC_ID AS IN_TARIFF_PROD_SVC_ID,
        RAT_IN.RATING_TYPE_ID AS IN_RATING_TYPE_ID,
        RAT_IN.NUMBER_OF_CALLS AS IN_NUMBER_OF_CALLS,

        RAT_IN_SETUP.UNIT_TARIFF AS IN_UNIT_TARIFF_SETUP_FEE,
        RAT_IN_SETUP.AMOUNT AS IN_AMOUNT_SETUPFEE,
        RAT_IN_SETUP.TARIFF_ELEMENT_ID AS IN_TARIFF_ELEMENT_ID_SETUPFEE,
        --NULL AS IN_AMOUNT_EURO,
         CAST(NULL AS DECIMAL(10,6)) AS IN_AMOUNT_EURO,
        --NULL AS IN_AMOUNT_SETUPFEE_EURO,
        CAST(NULL AS DECIMAL(10,6)) AS IN_AMOUNT_SETUPFEE_EURO,
        --NULL AS IN_UNIT_TARIFF_EURO,
       CAST(NULL AS DECIMAL(10,6)) As IN_UNIT_TARIFF_EURO,
       -- NULL AS IN_UNIT_TARIFF_SETUP_FEE_EURO,
        CAST(NULL AS DECIMAL(10,6)) AS IN_UNIT_TARIFF_SETUP_FEE_EURO,

        RAT_IN.IN_OUT_IND AS IN_IND,

        RAT_OUT.OPER_ID AS OUT_ACCOUNT_OPER_ID,
        RAT_OUT.REVN_EXP_IND AS OUT_REVN_EXP_IND, 
        RAT_OUT.AMOUNT AS OUT_AMOUNT, 
        RAT_OUT.CURRENCY_ID AS OUT_CURRENCY_ID, 
        RAT_OUT.NUMBER_OF_UNITS AS OUT_NUMBER_OF_UNITS,
        RAT_OUT.ORIGINAL_NUMBER_OF_UNITS AS OUT_ORIGINAL_NUMBER_OF_UNITS,
        RAT_OUT.TARIFF_ELEMENT_ID AS OUT_TARIFF_ELEMENT_ID,
        RAT_OUT.TARIFF_TYPE_ID AS OUT_TARIFF_TYPE_ID,
        RAT_OUT.TIME_DIFF_INTERVAL_ID AS OUT_TIME_DIFF_INTERVAL_ID,
        RAT_OUT.UNIT_TARIFF AS OUT_UNIT_TARIFF,
        RAT_OUT.TARIFF_GRP_ID AS OUT_TARIFF_GRP_ID,
        RAT_OUT.TARIFF_PROD_SVC_ID AS OUT_TARIFF_PROD_SVC_ID,
        RAT_OUT.RATING_TYPE_ID AS OUT_RATING_TYPE_ID,
        RAT_OUT.NUMBER_OF_CALLS AS OUT_NUMBER_OF_CALLS,

        RAT_OUT_SETUP.UNIT_TARIFF AS OUT_UNIT_TARIFF_SETUP_FEE,
        RAT_OUT_SETUP.AMOUNT AS OUT_AMOUNT_SETUPFEE,
        RAT_OUT_SETUP.TARIFF_ELEMENT_ID AS OUT_TARIFF_ELEMENT_ID_SETUPFEE,
        --NULL AS OUT_AMOUNT_EURO,
        CAST(NULL AS DECIMAL(10,6)) AS OUT_AMOUNT_EURO,
        --NULL AS OUT_AMOUNT_SETUPFEE_EURO,
        CAST(NULL AS DECIMAL(10,6)) AS OUT_AMOUNT_SETUPFEE_EURO,
       -- NULL AS OUT_UNIT_TARIFF_EURO,
        CAST(NULL AS DECIMAL(10,6)) AS OUT_UNIT_TARIFF_EURO,
       -- NULL AS OUT_UNIT_TARIFF_SETUP_FEE_EURO,
        CAST(NULL AS DECIMAL(10,6)) AS OUT_UNIT_TARIFF_SETUP_FEE_EURO,

        RAT_OUT.IN_OUT_IND AS OUT_IND,
        CASE WHEN IBNR.CALL_DURATION_TM = 0
                THEN 'Z'
                ELSE 'Y'
        END AS FLAG_IND,
        IBNR.LOAD_DT,
        IBNR.BEARER,
       -- NULL AS DIRECTION, 
        CAST(NULL AS VARCHAR(10)) AS DIRECTION, -- This needs to change again to null once we get the schema
        --NULL AS PRODUCT,
        CAST(NULL AS VARCHAR(10)) AS PRODUCT, -- This needs to change again to null once we get the schema

        IBNR.SALES_DEST_DIALLED_NR,
        IBNR.SALES_DEST_ROUTED_NR,
        IBNR.DEST_SUB_SVC_CD,
        IBNR.FIX_MOBILE,
        IBNR.IN_DEST_ACCESS_AREA_ID,                IBNR.OUT_DEST_ACCESS_AREA_ID,

        --NULL AS IN_UNIT_TARIFF_EURO_SAM,
        --NULL AS IN_CHANGE_COMMENT_SAM,
        --NULL AS IN_VIRTUAL_UNIT_TARIFF_EURO_SMART,
        --NULL AS IN_CHANGE_COMMENT_SMART,
       -- NULL AS IN_UNIT_TARIFF_EURO_FINAL,
       CAST(NULL AS DECIMAL(18,6)) AS IN_UNIT_TARIFF_EURO_FINAL,
        --NULL AS IN_CHANGE_COMMENT_FINAL,
       -- NULL AS OUT_UNIT_TARIFF_EURO_SAM,
       CAST(NULL AS DECIMAL(18,6)) AS OUT_UNIT_TARIFF_EURO_SAM,
       -- NULL AS OUT_CHANGE_COMMENT_SAM,
       CAST(NULL AS DECIMAL(18,6)) AS OUT_CHANGE_COMMENT_SAM,
       -- NULL AS OUT_VIRTUAL_UNIT_TARIFF_EURO_SMART,
       CAST(NULL AS DECIMAL(18,6)) AS OUT_VIRTUAL_UNIT_TARIFF_EURO_SMART,
        --NULL AS OUT_CHANGE_COMMENT_SMART,
       CAST(NULL AS DECIMAL(18,6)) As OUT_CHANGE_COMMENT_SMART,
       -- NULL AS OUT_UNIT_TARIFF_EURO_FINAL,
       CAST(NULL AS DECIMAL(18,6)) AS OUT_UNIT_TARIFF_EURO_FINAL,
       -- NULL AS OUT_CHANGE_COMMENT_FINAL,
       CAST(NULL AS DECIMAL(18,6)) As  OUT_CHANGE_COMMENT_FINAL,
       -- commenting temporarily for datatype mismatch
    /*
        NULL AS A_NR_CTRY_CD,
        NULL AS B_NR_CTRY_CD,
        NULL AS VAS_NAT_OUT_CALL_SRV_FLAG,
        NULL AS ONNET_OFFNET_FLAG,
        NULL AS DEST_OPER_ID,
        NULL AS VAS_PORT_IN,*/

        CAST(NULL AS VARCHAR(3)) AS A_NR_CTRY_CD,
        CAST(NULL AS VARCHAR(3)) AS B_NR_CTRY_CD,
        CAST(NULL AS INT)AS VAS_NAT_OUT_CALL_SRV_FLAG,
        CAST(NULL AS INT) AS ONNET_OFFNET_FLAG,
        CAST(NULL AS INT) AS DEST_OPER_ID,
        CAST(NULL AS INT) AS VAS_PORT_IN,

        IBNR.ROUTING_DEST_DIALLED_NR,
        IBNR.ROUTING_DEST_ROUTED_NR,
        -- NULL AS ORIGINAL_PRODUCT,
        CAST(NULL AS VARCHAR(20)) AS ORIGINAL_PRODUCT, --datatype missmatch
        --NULL AS VAS_DIRECTORY_SRV_FLAG,
        --NULL AS VAS_EMERGENCY_SRV_FLAG,
              
       -- commenting temporarily for datatype mismatch

/*
        NULL AS CUST_OPER_ID,
        NULL AS CUST_TGC_ID,
        NULL AS CUST_CURRENCY_ID,
        NULL AS ORIG_OPER_ID,
        NULL AS SUPPL_OPER_ID,
        NULL AS SUPPL_TGC_ID,
        NULL AS SUPPL_CURRENCY_ID,
        NULL AS CUST_DEST_SUB_SVC_ID,
        NULL AS SUPPL_DEST_SUB_SVC_ID,
        */
        
        CAST(NULL AS INT) AS CUST_OPER_ID,
        CAST(NULL AS INT) AS CUST_TGC_ID,
        CAST(NULL AS INT) AS CUST_CURRENCY_ID,
        CAST(NULL AS INT) AS ORIG_OPER_ID,
        CAST(NULL AS INT) AS SUPPL_OPER_ID,
        CAST(NULL AS INT) AS SUPPL_TGC_ID,
        CAST(NULL AS INT) AS SUPPL_CURRENCY_ID,
        CAST(NULL AS INT) AS CUST_DEST_SUB_SVC_ID,
        CAST(NULL AS INT) AS SUPPL_DEST_SUB_SVC_ID,
        -- IN/OUT New Fields (15/09/2023)
               -- commenting temporarily for datatype mismatch

        /*
        NULL AS IN_UNIT_TARIFF_EURO_FINANCIAL,
        NULL AS IN_UNIT_TARIFF_OC_FINAL,
        NULL AS IN_UNIT_TARIFF_OC_FINANCIAL,
        NULL AS IN_UNIT_TARIFF_SETUP_FEE_OC,
        NULL AS OUT_UNIT_TARIFF_EURO_COGS,
        NULL AS OUT_UNIT_TARIFF_OC_FINAL,
        NULL AS OUT_UNIT_TARIFF_OC_FINANCIAL,
        NULL AS OUT_UNIT_TARIFF_SETUP_FEE_OC,
        -- Manual Correction New Fields (04/01/2024)
        NULL AS IN_UNIT_TARIFF_EURO_CORR,
        NULL AS IN_CHANGE_COMMENT_CORR,
        NULL AS OUT_UNIT_TARIFF_EURO_CORR,
        NULL AS OUT_CHANGE_COMMENT_CORR,
        NULL AS IN_CHANGE_COMMENT_FINAL,
        NULL AS VAS_PORT_OUT,
        NULL AS REVENUE,
        NULL AS COST,*/

        CAST(NULL AS DECIMAL(18,6))  AS IN_UNIT_TARIFF_EURO_FINANCIAL,
        CAST(NULL AS DECIMAL(18,6))  AS IN_UNIT_TARIFF_OC_FINAL,
        CAST(NULL AS DECIMAL(18,6))  AS IN_UNIT_TARIFF_OC_FINANCIAL,
        CAST(NULL AS DECIMAL(18,6))  AS IN_UNIT_TARIFF_SETUP_FEE_OC,
        CAST(NULL AS DECIMAL(18,6))  AS OUT_UNIT_TARIFF_EURO_COGS,
        CAST(NULL AS DECIMAL(18,6))  AS OUT_UNIT_TARIFF_OC_FINAL,
        CAST(NULL AS DECIMAL(18,6))  AS OUT_UNIT_TARIFF_OC_FINANCIAL,
        CAST(NULL AS DECIMAL(18,6)) AS OUT_UNIT_TARIFF_SETUP_FEE_OC,
        -- Manual Correction New Fields (04/01/2024)
        CAST(NULL AS DECIMAL(15,6)) AS IN_UNIT_TARIFF_EURO_CORR,
        CAST(NULL AS VARCHAR(40)) AS IN_CHANGE_COMMENT_CORR,
        CAST(NULL AS DECIMAL(15,6)) AS OUT_UNIT_TARIFF_EURO_CORR,
        CAST(NULL AS VARCHAR(40)) AS OUT_CHANGE_COMMENT_CORR,
        CAST(NULL AS VARCHAR(40)) AS IN_CHANGE_COMMENT_FINAL,
        CAST(NULL AS INT) AS VAS_PORT_OUT,
        CAST(NULL AS DECIMAL(18,6)) AS REVENUE,
        CAST(NULL AS DECIMAL(18,6)) AS COST
        
FROM {{ ref('Q2_IBIS_CALL_MAPFULL_CCOM_NO_RATING') }} IBNR

LEFT OUTER JOIN {{ ref('IBIS_RATING') }} RAT_IN
    ON IBNR.IN_CDR_FILE_ID = RAT_IN.CDR_FILE_ID
   AND IBNR.IN_CDR_SERIAL_NR = RAT_IN.CDR_SERIAL_NR
   AND IBNR.IN_SEGMENT_DT = RAT_IN.SEGMENT_DT
   AND RAT_IN.IN_OUT_IND = 'I'
   AND RAT_IN.TARIFF_TYPE_ID <> 16

LEFT OUTER JOIN {{ ref('IBIS_RATING') }} RAT_OUT
    ON IBNR.OUT_CDR_FILE_ID = RAT_OUT.CDR_FILE_ID
   AND IBNR.OUT_CDR_SERIAL_NR = RAT_OUT.CDR_SERIAL_NR
   AND IBNR.OUT_SEGMENT_DT = RAT_OUT.SEGMENT_DT
   AND RAT_OUT.IN_OUT_IND = 'O'
   AND RAT_OUT.TARIFF_TYPE_ID <> 16
   AND RAT_OUT.TARIFF_PROD_SVC_ID NOT IN ('2105605','2104331')

LEFT OUTER JOIN {{ref('IBIS_RATING') }} RAT_IN_SETUP
    ON IBNR.IN_CDR_FILE_ID = RAT_IN_SETUP.CDR_FILE_ID
   AND IBNR.IN_CDR_SERIAL_NR = RAT_IN_SETUP.CDR_SERIAL_NR
   AND IBNR.IN_SEGMENT_DT = RAT_IN_SETUP.SEGMENT_DT
   AND RAT_IN.NUMBER_OF_CALLS = 1
   AND RAT_IN_SETUP.IN_OUT_IND = 'I'
   AND RAT_IN_SETUP.TARIFF_TYPE_ID = 16

LEFT OUTER JOIN {{ ref('IBIS_RATING') }} RAT_OUT_SETUP
    ON IBNR.OUT_CDR_FILE_ID = RAT_OUT_SETUP.CDR_FILE_ID
   AND IBNR.OUT_CDR_SERIAL_NR = RAT_OUT_SETUP.CDR_SERIAL_NR
   AND IBNR.OUT_SEGMENT_DT = RAT_OUT_SETUP.SEGMENT_DT
   AND RAT_OUT_SETUP.NUMBER_OF_CALLS = 1
   AND RAT_OUT_SETUP.IN_OUT_IND = 'O'
   AND RAT_OUT_SETUP.TARIFF_TYPE_ID = 16
   AND RAT_OUT_SETUP.TARIFF_PROD_SVC_ID NOT IN ('2105605','2104331')

WHERE COALESCE(IBNR.IN_VAS_DIRECTION, 'NA') <> 'INBOUND'
