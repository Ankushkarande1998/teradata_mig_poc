-- File: 8
{{ config(
    materialized='table',
    pre_hook="DROP TABLE IF EXISTS {{ this }}"
    ) 
}}


with  pop_2_raw_data AS(
SELECT 
    CALL_DT,
    IN_CDR_FILE_ID,
    IN_CDR_SERIAL_NR,
    IN_SEGMENT_DT,
    OUT_CDR_FILE_ID,
    OUT_CDR_SERIAL_NR,
    OUT_SEGMENT_DT,
    MAP_STATUS,
    TRANSM_OPER_ID,
    I_TGC_ID,
    RECV_OPER_ID,
    O_TGC_ID,
    IN_DEST_OPER_ID,
    OUT_DEST_OPER_ID,
    CALL_SET_UP_DURATION,
    OUT_ORIGINAL_NUMBER_OF_UNITS AS CALL_DURATION_TM,
    ADD_ORIG_OPER_ID,
    DIALLED_NR,
    ROUTED_NR,
    A_NR,
    IN_DEST_SUB_SVC_ID,
    OUT_DEST_SUB_SVC_ID,
    IN_VAS_DIRECTION,
    IN_VAS_PRODUCT,
    IN_VAS_ACCESS_NUMBER,
    IN_VAS_CUSTOMER_ROUTING_NUMBER,
    IN_VAS_B_NUMBER,
    IN_VAS_B_NUMBER_CTRY_CD,
    OUT_VAS_DIRECTION,
    OUT_VAS_PRODUCT,
    OUT_VAS_ACCESS_NUMBER,
    OUT_VAS_CUSTOMER_ROUTING_NUMBER,
    OUT_VAS_B_NUMBER,
    OUT_VAS_B_NUMBER_CTRY_CD,
    IN_GLOBAL_CALL_ID,
    OUT_GLOBAL_CALL_ID,
    IN_ACCOUNT_OPER_ID,
    IN_REVN_EXP_IND,
    (OUT_NUMBER_OF_UNITS * IN_UNIT_TARIFF)/60.0 AS IN_AMOUNT,
    IN_CURRENCY_ID,
    IN_NUMBER_OF_UNITS,
    OUT_ORIGINAL_NUMBER_OF_UNITS AS IN_ORIGINAL_NUMBER_OF_UNITS,
    IN_TARIFF_ELEMENT_ID,
    IN_TARIFF_TYPE_ID,
    IN_TIME_DIFF_INTERVAL_ID,
    IN_UNIT_TARIFF,
    IN_TARIFF_GRP_ID,
    IN_TARIFF_PROD_SVC_ID,
    IN_RATING_TYPE_ID,
    OUT_NUMBER_OF_CALLS AS IN_NUMBER_OF_CALLS,
    IN_UNIT_TARIFF_SETUP_FEE,
    IN_AMOUNT_SETUPFEE,
    IN_TARIFF_ELEMENT_ID_SETUPFEE,
    IN_AMOUNT_EURO,
    IN_AMOUNT_SETUPFEE_EURO,
    IN_UNIT_TARIFF_EURO,
    IN_UNIT_TARIFF_SETUP_FEE_EURO,
    IN_IND,
    OUT_ACCOUNT_OPER_ID,
    OUT_REVN_EXP_IND,
    OUT_AMOUNT,
    OUT_CURRENCY_ID,
    OUT_NUMBER_OF_UNITS,
    OUT_ORIGINAL_NUMBER_OF_UNITS,
    OUT_TARIFF_ELEMENT_ID,
    OUT_TARIFF_TYPE_ID,
    OUT_TIME_DIFF_INTERVAL_ID,
    OUT_UNIT_TARIFF,
    OUT_TARIFF_GRP_ID,
    OUT_TARIFF_PROD_SVC_ID,
    OUT_RATING_TYPE_ID,
    OUT_NUMBER_OF_CALLS,
    OUT_UNIT_TARIFF_SETUP_FEE,
    OUT_AMOUNT_SETUPFEE,
    OUT_TARIFF_ELEMENT_ID_SETUPFEE,
    OUT_AMOUNT_EURO,
    OUT_AMOUNT_SETUPFEE_EURO,
    OUT_UNIT_TARIFF_EURO,
    OUT_UNIT_TARIFF_SETUP_FEE_EURO,
    OUT_IND,
    FLAG_IND,
    LOAD_DT,
    BEARER,
    DIRECTION,
    PRODUCT,
    SALES_DEST_DIALLED_NR,
    SALES_DEST_ROUTED_NR,
    DEST_SUB_SVC_CD,
    FIX_MOBILE,
    IN_DEST_ACCESS_AREA_ID,
    OUT_DEST_ACCESS_AREA_ID,
    IN_UNIT_TARIFF_EURO_FINAL,
    OUT_UNIT_TARIFF_EURO_SAM,
    OUT_CHANGE_COMMENT_SAM,
    OUT_VIRTUAL_UNIT_TARIFF_EURO_SMART,
    OUT_CHANGE_COMMENT_SMART,
    OUT_UNIT_TARIFF_EURO_FINAL,
    OUT_CHANGE_COMMENT_FINAL,
    A_NR_CTRY_CD,
    B_NR_CTRY_CD,
    VAS_NAT_OUT_CALL_SRV_FLAG,
    ONNET_OFFNET_FLAG,
    DEST_OPER_ID,
    VAS_PORT_IN,
    ROUTING_DEST_DIALLED_NR,
    ROUTING_DEST_ROUTED_NR,
    ORIGINAL_PRODUCT,
    CUST_OPER_ID,
    CUST_TGC_ID,
    CUST_CURRENCY_ID,
    ORIG_OPER_ID,
    SUPPL_OPER_ID,
    SUPPL_TGC_ID,
    SUPPL_CURRENCY_ID,
    CUST_DEST_SUB_SVC_ID,
    SUPPL_DEST_SUB_SVC_ID,
    IN_UNIT_TARIFF_EURO_FINANCIAL,
    IN_UNIT_TARIFF_OC_FINAL,
    IN_UNIT_TARIFF_OC_FINANCIAL,
    IN_UNIT_TARIFF_SETUP_FEE_OC,
    OUT_UNIT_TARIFF_EURO_COGS,
    OUT_UNIT_TARIFF_OC_FINAL,
    OUT_UNIT_TARIFF_OC_FINANCIAL,
    OUT_UNIT_TARIFF_SETUP_FEE_OC,
    IN_UNIT_TARIFF_EURO_CORR,
    IN_CHANGE_COMMENT_CORR,
    OUT_UNIT_TARIFF_EURO_CORR,
    OUT_CHANGE_COMMENT_CORR,
    IN_CHANGE_COMMENT_FINAL,
    VAS_PORT_OUT,
    REVENUE,
    COST,
    IN_VAS_ACCESS_TYPE,
    OUT_VAS_ACCESS_TYPE,
    IN_VAS_CUSTOMER_POP,
    OUT_VAS_CUSTOMER_POP,
    MINIMUM_PRICE_PER_MINUTE_FEE,
    MINIMUM_PRICE_SETUP_FEE,
    RETAIL_PRICE_PER_MINUTE_FEE,
    RETAIL_PRICE_SETUP_FEE
FROM {{ ref('Q1_CCOM_IC_RATING_IO_DUPL_POP_1') }}
WHERE (IN_CDR_FILE_ID, IN_CDR_SERIAL_NR,  COALESCE(IN_NUMBER_OF_UNITS,0)) IN (
    SELECT IN_CDR_FILE_ID, IN_CDR_SERIAL_NR, IN_NUMBER_OF_UNITS
    FROM (    
        SELECT 
        IN_CDR_FILE_ID,
        IN_CDR_SERIAL_NR,
         COALESCE(IN_NUMBER_OF_UNITS,0)  AS IN_NUMBER_OF_UNITS,
        {{ sum_window('OUT_NUMBER_OF_UNITS', 'IN_CDR_FILE_ID, IN_CDR_SERIAL_NR') }} AS SUM_OUT_NBR_OF_UNITS
    FROM {{ ref('Q1_CCOM_IC_RATING_IO_DUPL_POP_1') }}
    )
    WHERE ABS(IN_NUMBER_OF_UNITS - SUM_OUT_NBR_OF_UNITS) <= 2
    GROUP BY 1,2,3
)
)

--delete duplicate from pop_2
SELECT * FROM pop_2_raw_data
WHERE (IN_CDR_FILE_ID, IN_CDR_SERIAL_NR, COALESCE(IN_NUMBER_OF_UNITS,0), COALESCE(IN_NUMBER_OF_CALLS,0)) NOT IN
  ( 
  SELECT  IN_CDR_FILE_ID, IN_CDR_SERIAL_NR, COALESCE(IN_NUMBER_OF_UNITS,0), COALESCE(IN_NUMBER_OF_CALLS,0)
  FROM    pop_2_raw_data
  --WHERE FLAG_IND <> 'V' 
  GROUP BY 1,2,3,4 HAVING COUNT(*) > 1
  )
  AND (OUT_CDR_FILE_ID, OUT_CDR_SERIAL_NR, COALESCE(OUT_NUMBER_OF_UNITS,0), COALESCE(OUT_NUMBER_OF_CALLS,0)) NOT IN
    (
    SELECT  OUT_CDR_FILE_ID, OUT_CDR_SERIAL_NR, COALESCE(OUT_NUMBER_OF_UNITS,0), COALESCE(OUT_NUMBER_OF_CALLS,0)
    FROM    pop_2_raw_data
    --WHERE FLAG_IND <> 'V'
    GROUP BY 1,2,3,4 
    HAVING COUNT(*) > 1
    )



