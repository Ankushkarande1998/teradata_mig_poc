{{ config(
    materialized='table',
    pre_hook="DROP TABLE IF EXISTS {{ this }}"
    ) 
}}

--update main table
SELECT
    A.CALL_DT,               
    A.IN_CDR_FILE_ID,        
    A.IN_CDR_SERIAL_NR,
    A.IN_SEGMENT_DT,         
    A.OUT_CDR_FILE_ID,       
    A.OUT_CDR_SERIAL_NR,
    A.ONNET_OFFNET_FLAG,
    A.VAS_PORT_IN,
    A.VAS_PORT_OUT,
    A.OUT_SEGMENT_DT,        
    A.MAP_STATUS,            
    A.TRANSM_OPER_ID,
    A.I_TGC_ID,              
    A.RECV_OPER_ID,          
    A.O_TGC_ID,
    A.IN_DEST_OPER_ID,       
    A.OUT_DEST_OPER_ID,
    A.CALL_SET_UP_DURATION,  
    A.CALL_DURATION_TM,      
    A.ADD_ORIG_OPER_ID,
    A.DIALLED_NR,            
    A.ROUTED_NR,             
    A.A_NR,
    A.IN_DEST_SUB_SVC_ID,    
    A.OUT_DEST_SUB_SVC_ID,   
    A.IN_VAS_DIRECTION,
    A.IN_VAS_PRODUCT,        
    A.IN_VAS_ACCESS_NUMBER,  
    A.IN_VAS_CUSTOMER_ROUTING_NUMBER,
    A.IN_VAS_B_NUMBER,       
    A.IN_VAS_B_NUMBER_CTRY_CD,
    A.OUT_VAS_DIRECTION,     
    A.OUT_VAS_PRODUCT,        
    A.OUT_VAS_ACCESS_NUMBER,
    A.OUT_VAS_CUSTOMER_ROUTING_NUMBER,
    A.OUT_VAS_B_NUMBER,      
    A.OUT_VAS_B_NUMBER_CTRY_CD,
    A.IN_GLOBAL_CALL_ID,
    A.OUT_GLOBAL_CALL_ID,
    A.IN_ACCOUNT_OPER_ID,
    A.IN_REVN_EXP_IND,
    A.IN_AMOUNT,
    A.IN_CURRENCY_ID,
    A.IN_NUMBER_OF_UNITS,
    A.IN_ORIGINAL_NUMBER_OF_UNITS,
    A.IN_TARIFF_ELEMENT_ID,
    A.IN_TARIFF_TYPE_ID,
    A.IN_TIME_DIFF_INTERVAL_ID,
    A.IN_UNIT_TARIFF,
    A.IN_TARIFF_GRP_ID,
    A.IN_TARIFF_PROD_SVC_ID,
    A.IN_RATING_TYPE_ID,
    A.IN_NUMBER_OF_CALLS,
    A.IN_UNIT_TARIFF_SETUP_FEE,
    A.IN_AMOUNT_SETUPFEE,
    A.IN_TARIFF_ELEMENT_ID_SETUPFEE,
    A.IN_IND,
    A.OUT_ACCOUNT_OPER_ID,
    A.OUT_REVN_EXP_IND, 
    A.OUT_AMOUNT, 
    A.OUT_CURRENCY_ID,  
    A.OUT_ORIGINAL_NUMBER_OF_UNITS,
    A.OUT_TARIFF_ELEMENT_ID,
    A.OUT_TARIFF_TYPE_ID,
    A.OUT_TIME_DIFF_INTERVAL_ID,
    A.OUT_UNIT_TARIFF,
    A.OUT_TARIFF_GRP_ID,
    A.OUT_TARIFF_PROD_SVC_ID,
    A.OUT_RATING_TYPE_ID,
    A.OUT_NUMBER_OF_CALLS,
    A.OUT_UNIT_TARIFF_SETUP_FEE,
    A.OUT_AMOUNT_SETUPFEE,
    A.OUT_TARIFF_ELEMENT_ID_SETUPFEE,
    A.OUT_IND,
    A.LOAD_DT,
    A.BEARER,
    A.DIRECTION,
    A.PRODUCT,
    A.SALES_DEST_DIALLED_NR,
    A.SALES_DEST_ROUTED_NR,
    A.DEST_SUB_SVC_CD,
    A.FIX_MOBILE,
    A.IN_DEST_ACCESS_AREA_ID,                
    A.OUT_DEST_ACCESS_AREA_ID,
    A.IN_UNIT_TARIFF_EURO_FINAL,
    A.OUT_UNIT_TARIFF_EURO_SAM,
    A.OUT_CHANGE_COMMENT_SAM,
    A.OUT_VIRTUAL_UNIT_TARIFF_EURO_SMART,
    A.OUT_CHANGE_COMMENT_SMART,
    A.OUT_UNIT_TARIFF_EURO_FINAL,
    A.OUT_CHANGE_COMMENT_FINAL,
    A.A_NR_CTRY_CD,
    A.B_NR_CTRY_CD,
    A.VAS_NAT_OUT_CALL_SRV_FLAG,
    A.DEST_OPER_ID,
    A.ROUTING_DEST_DIALLED_NR,
    A.ROUTING_DEST_ROUTED_NR,
    B.ORIGINAL_PRODUCT,
    A.CUST_OPER_ID,
    A.CUST_TGC_ID,
    A.CUST_CURRENCY_ID,
    A.ORIG_OPER_ID,
    A.SUPPL_OPER_ID,
    A.SUPPL_TGC_ID,
    A.SUPPL_CURRENCY_ID,
    A.CUST_DEST_SUB_SVC_ID,
    A.SUPPL_DEST_SUB_SVC_ID,
    A.IN_UNIT_TARIFF_EURO_FINANCIAL,
    A.IN_UNIT_TARIFF_OC_FINAL,
    A.IN_UNIT_TARIFF_OC_FINANCIAL,
    A.IN_UNIT_TARIFF_SETUP_FEE_OC,
    A.OUT_UNIT_TARIFF_EURO_COGS,
    A.OUT_UNIT_TARIFF_OC_FINAL,
    A.OUT_UNIT_TARIFF_OC_FINANCIAL,
    A.OUT_UNIT_TARIFF_SETUP_FEE_OC,
    A.IN_UNIT_TARIFF_EURO_CORR,
    A.IN_CHANGE_COMMENT_CORR,
    A.OUT_NUMBER_OF_UNITS,
    A.OUT_UNIT_TARIFF_EURO_CORR,
    A.OUT_CHANGE_COMMENT_CORR,
    A.IN_CHANGE_COMMENT_FINAL,
    A.REVENUE,
    A.COST,
    A.IN_VAS_ACCESS_TYPE,
    A.OUT_VAS_ACCESS_TYPE,
    A.IN_VAS_CUSTOMER_POP,
    A.OUT_VAS_CUSTOMER_POP,
    A.FLAG_IND,
    A.IN_UNIT_TARIFF_EURO,
    A.IN_UNIT_TARIFF_SETUP_FEE_EURO,
    A.IN_AMOUNT_EURO,
    A.IN_AMOUNT_SETUPFEE_EURO, 
    CASE 
        WHEN A.DIRECTION = 'OUTBOUND' THEN MP.MINIMUM_PRICE
        ELSE VAS.MIN_INB_U_PER_MINUTE_FEE
    END AS MINIMUM_PRICE_PER_MINUTE_FEE,
     CASE 
        WHEN A.DIRECTION = 'OUTBOUND' THEN MP.MINIMUM_PRICE
        ELSE VAS.RET_INB_U_PER_MINUTE_FEE
    END AS RETAIL_PRICE_PER_MINUTE_FEE,
    CASE 
        WHEN A.DIRECTION = 'INBOUND' THEN VAS.MIN_INB_U_CALL_START_UP_FEE 
        ELSE A.MINIMUM_PRICE_SETUP_FEE 
    END AS MINIMUM_PRICE_SETUP_FEE,

    CASE 
        WHEN A.DIRECTION = 'INBOUND' THEN VAS.RET_INB_U_CALL_START_UP_FEE 
        ELSE A.RETAIL_PRICE_SETUP_FEE 
    END AS RETAIL_PRICE_SETUP_FEE


    FROM 
   {{ref('Q1_IBIS_CALL_MAPFULL_CCOM_RATING_SERVICES_FLAG')}} A 
   LEFT JOIN {{ref('Q1_CCOM_ORIGINAL_PRODUCT')}} B
ON 1=1
   AND A.CALL_DT = B.CALL_DT
   AND COALESCE(A.IN_CDR_FILE_ID, 0) = COALESCE(B.IN_CDR_FILE_ID, 0)
   AND COALESCE(A.IN_CDR_SERIAL_NR, 0) = COALESCE(B.IN_CDR_SERIAL_NR, 0)
   AND COALESCE(A.OUT_CDR_FILE_ID, 0) = COALESCE(B.OUT_CDR_FILE_ID, 0)
   AND COALESCE(A.OUT_CDR_SERIAL_NR, 0) = COALESCE(B.OUT_CDR_SERIAL_NR, 0)
   LEFT JOIN {{ref('IBIS_B_TIME_DIFF_INTERVAL')}} TD
   ON 
    TD.TIME_DIFF_INTERVAL_ID = COALESCE(A.IN_TIME_DIFF_INTERVAL_ID, A.OUT_TIME_DIFF_INTERVAL_ID)
   LEFT JOIN {{ref('IBIS_ACCESS_AREA')}} AA
   ON AA.ACCESS_AREA_ID = COALESCE(A.IN_DEST_ACCESS_AREA_ID, A.OUT_DEST_ACCESS_AREA_ID)
    LEFT JOIN
        (
    SELECT  MP.START_DT AS CALL_DT,
            MP.ROUTINGDESTINATIONFIELD AS ROUTING_DEST,
            MP.ROUTINGTDEFIELD AS TIME_DIFF_ELEM_CD,
            CASE
                WHEN MP.BASE_PRODUCT = 'FIRST CLASS MOB' THEN 'FCM'
                WHEN MP.BASE_PRODUCT = 'SIP' THEN 'SIPT'
                WHEN MP.BASE_PRODUCT = 'OTT' THEN 'GMN'
            END AS SOLD_PRODUCT,
            MAX(MP.MinimumPriceField) MINIMUM_PRICE
    FROM {{ref('CDO_IN_MIN_PRICE')}} MP
    WHERE 1=1
    AND MP.START_DT BETWEEN {{convert_start_date('202502')}} AND {{get_date_sub(1)}}
       --AND MP.START_DT BETWEEN (('2025-03-11' (DATE)) - INTERVAL '11' DAY) AND (('2025-03-11' (DATE)) - INTERVAL '1' DAY)
       AND MP.BASE_PRODUCT IN ('FIRST CLASS MOB', 'SIP', 'OTT')
    GROUP BY 1, 2, 3, 4
   ) MP

   ON
    MP.ROUTING_DEST = COALESCE(A.ROUTING_DEST_ROUTED_NR, A.ROUTING_DEST_DIALLED_NR)
   AND MP.CALL_DT = A.CALL_DT
   AND MP.TIME_DIFF_ELEM_CD = TD.TIME_DIFF_ELEMENT_CD
   AND MP.SOLD_PRODUCT = A.PRODUCT

   LEFT JOIN   (
    SELECT  V.CURRENCY,        V.PRODUCT,        
            S.OPER_ID AS SUPPLIER_OPER_ID,  V.SUPPLIER,
            CTRY.CTRY_CD AS COUNTRY_CD,
            V.COUNTRY,
            CASE WHEN V.ACCESS_AREA = 'NA'
                    THEN 'Not applicable' 
                    ELSE V.ACCESS_AREA
            END AS REF_PRICES_ACCESS_AREA,
            V.ACCESS_TYPE,
            --ACCESS_NETWORK,
            V.TDE,
            -- We will do a MAX for the time being as we have more than 
            -- one record due to the field ACCESS_NETWORK and we do know
            -- where we can find this record in IBIS_CALL or other to make the join
            MAX(V.RET_INB_U_CALL_START_UP_FEE) AS RET_INB_U_CALL_START_UP_FEE,
            MAX(V.RET_INB_U_PER_MINUTE_FEE) AS RET_INB_U_PER_MINUTE_FEE,
            MAX(V.MIN_INB_U_CALL_START_UP_FEE) AS MIN_INB_U_CALL_START_UP_FEE,
            MAX(V.MIN_INB_U_PER_MINUTE_FEE) AS MIN_INB_U_PER_MINUTE_FEE
    FROM {{ref('VAS_EXT_MIN_REF_PRICES')}} V
    LEFT OUTER JOIN {{ref('IBIS_B_OPERATOR')}} S
        ON SUPPLIER = S.CTRY_CD || '/' || S.OPER_CD
    LEFT OUTER JOIN {{ref('IBIS_COUNTRY')}} CTRY
        ON V.COUNTRY = CTRY.CTRY_NM
    WHERE 1=1
    GROUP BY 1,2,3,4,5,6,7,8,9
   ) VAS

   ON 
   REF_PRICES_ACCESS_AREA = AA.ACCESS_AREA_NM
   AND VAS.TDE = TD.TIME_DIFF_ELEMENT_CD 
   AND VAS.PRODUCT = A.PRODUCT
   AND VAS.SUPPLIER_OPER_ID = A.SUPPL_OPER_ID
   AND VAS.COUNTRY_CD = A_NR_CTRY_CD
   AND VAS.ACCESS_TYPE = COALESCE(A.IN_VAS_ACCESS_TYPE, A.OUT_VAS_ACCESS_TYPE)


